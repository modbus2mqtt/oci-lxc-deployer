{
  "$id": "template",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "template",
  "type": "object",
  "properties": {
    "execute_on": {
      "anyOf": [
        { "const": "ve" },
        { "const": "lxc" },
        { "type": "string", "pattern": "^host:.*$" },
        { "type": "string", "pattern": "^application:.*$" }
      ]
    },
    "skip_if_all_missing": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "List of parameter IDs. If ALL of these are missing or empty, the template will be skipped. If at least one parameter is present, the template will be executed. If this property is present (and not empty), the template is considered optional."
    },
    "skip_if_property_set": {
      "type": "string",
      "description": "Parameter ID. If this parameter is set (exists in resolvedParams), the template will be skipped."
    },
    "name": {
      "type": "string",
      "maxLength": 30
    },
    "description": {
      "type": "string"
    },
    "parameters": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "id": { "type": "string" },
          "if": { "type": "string" },
          "type": { "enum": ["string", "number", "enum", "boolean"] },
          "description": { "type": "string" },
          "multiline": { "type": "boolean", "default": false },
          "upload": { "type": "boolean", "default": false },
          "certtype": {
            "type": "string",
            "enum": ["ca", "ca_pub", "server", "fullchain"],
            "description": "Certificate type. Enables auto-generation when upload has no value."
          },
          "required": { "type": "boolean", "default": false },
          "validatePattern": { "type": "string", "default": false },
          "secure": { "type": "boolean", "default": false },
          "advanced": { "type": "boolean", "default": false },
          "internal": { "type": "boolean", "default": false, "description": "Internal parameter: not shown in application UI, only settable via addon properties." },
          "default": { "type": ["string", "number", "boolean"] }
        },
        "required": ["name", "id", "type"],
        "if": { "properties": { "type": { "const": "enum" } } },
        "then": {
          "properties": {
            "enumValues": {
              "type": "array",
              "items": { "anyOf": [ { "type": "string" }, { "type": "object", "properties": { "name": { "type": "string" }, "value": { "type": ["string", "number", "boolean"] } } } ] }
            },
            "enumValuesTemplate": {
              "type": "string"
            }
          },
          "anyOf": [
            { "required": ["enumValues"] },
            { "required": ["enumValuesTemplate"] }
          ]
        }
      }
    },
    "commands": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/command" }
    }
  },
  "if": {
    "properties": { "type": { "enum": ["command", "script", "template"] } }
  },
  "then": { "properties": { "enumValues": { "type": "string" } } },
  "required": ["commands", "name"],
  "additionalProperties": false,
  "$defs": {
    "command": {
      "type": "object",
      "properties": {
        "name": { "type": "string", "maxLength": 30 },
        "description": { "type": "string" },
        "command": { "type": "string" },
        "script": { "type": "string" },
        "library": {
          "type": "string",
          "description": "Optional: Path to library file (relative to scripts directory). Library will be prepended to script content."
        },
        "outputs": {
          "type": "array",
          "items": { "$ref": "output.template#" },
          "description": "Expected outputs from this command/script. If outputs are defined here, they will be validated after execution. If outputs are missing, an error will be raised."
        },
        "properties": {
          "description": "Sets parameter values (outputs). Use 'value' to set a resolved value (not editable), or 'default' to set a default value (editable by user). If a template has only one command with properties (and no script, command, or template), it is considered a properties-only template.",
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "value": {
                  "oneOf": [
                    { "type": ["string", "boolean", "number"] },
                    {
                      "type": "array",
                      "items": {
                        "oneOf": [
                          { "type": "string" },
                          {
                            "type": "object",
                            "properties": {
                              "name": { "type": "string" },
                              "value": { "type": ["string", "number", "boolean"] }
                            },
                            "required": ["name", "value"],
                            "additionalProperties": false
                          },
                          {
                            "type": "object",
                            "properties": {
                              "id": { "type": "string" },
                              "value": { "type": ["string", "number", "boolean"] }
                            },
                            "required": ["id", "value"],
                            "additionalProperties": false
                          }
                        ]
                      }
                    }
                  ]
                },
                "default": {
                  "type": ["string", "boolean", "number"],
                  "description": "Default value for the parameter. Unlike 'value', this will show the parameter as editable in the UI."
                }
              },
              "required": ["id"],
              "anyOf": [
                { "required": ["value"] },
                { "required": ["default"] }
              ],
              "additionalProperties": false
            },
            {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": { "type": "string" },
                  "value": {
                    "oneOf": [
                      { "type": ["string", "boolean", "number"] },
                      {
                        "type": "array",
                        "items": {
                          "oneOf": [
                            { "type": "string" },
                            {
                              "type": "object",
                              "properties": {
                                "name": { "type": "string" },
                                "value": { "type": ["string", "number", "boolean"] }
                              },
                              "required": ["name", "value"],
                              "additionalProperties": false
                            },
                            {
                              "type": "object",
                              "properties": {
                                "id": { "type": "string" },
                                "value": { "type": ["string", "number", "boolean"] }
                              },
                              "required": ["id", "value"],
                              "additionalProperties": false
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "default": {
                    "type": ["string", "boolean", "number"],
                    "description": "Default value for the parameter. Unlike 'value', this will show the parameter as editable in the UI."
                  }
                },
                "required": ["id"],
                "anyOf": [
                  { "required": ["value"] },
                  { "required": ["default"] }
                ],
                "additionalProperties": false
              }
            }
          ]
        },
        "template": { "type": "string" }
      },
      "oneOf": [
        { "required": ["command"] },
        { "required": ["script"] },
        { "required": ["properties"] },
        { "required": ["template"] }
      ],
      "errorMessage": {
        "oneOf": "Exactly one of 'command', 'script' or 'properties' must be present."
      },
      "additionalProperties": false
    }
  }
}
