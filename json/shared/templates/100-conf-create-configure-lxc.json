{
  "execute_on": "ve",
  "name": "Create and Configure LXC",
  "description": "Creates or reconfigures LXC container and applies optional configurations (templates 101-199).\n\n**New Installation Mode** (vm_id not set):\nCreates a new container using pct create and applies all configuration templates.\n\n**Reconfiguration Mode** (vm_id set and container exists):\nSkips pct create and only applies configuration changes. Existing mountpoints and environment variables are preserved (not removed).\n\nIf username is provided, a user will be created on the VE host before the container is created (template 095). This ensures consistent UID/GID mapping between host and container.\n\nNote: uid and gid parameters are used for volume permissions only, not for container idmap configuration. The container is created as unprivileged without automatic UID/GID mappings.\n\nTemplates included:\n- 095: Create User on VE Host (if username provided)\n- 100: Create LXC container (unprivileged, no idmap) - skipped in reconfiguration mode\n- 104: Compute Static IPs from prefixes\n- 105: Set Static IP for LXC\n- 106: Update /etc/hosts entries\n- 110: Map Serial Device\n- 150: Create Storage Volumes for LXC (only adds new, preserves existing)\n- 170: Set Environment Variables in LXC (only adds new, preserves existing)\n- 190: Write LXC Notes (managed marker, OCI image, links)",
  "parameters": [
    {
      "id": "vm_id",
      "name": "ID of the virtual machine",
      "type": "number",
      "default": "",
      "description": "ID of the virtual machine",
      "advanced": true
    },
    {
      "id": "template_path",
      "name": "Path to the LXC template",
      "type": "string",
      "description": "Path to the LXC template (e.g. local:vztmpl/alpine-3.19-default_20231107_amd64.tar.xz). Required for new installations (auto-selected for Alpine). Not needed in reconfiguration mode when vm_id points to an existing container."
    },
    {
      "id": "oci_image",
      "name": "OCI Image",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Optional: OCI image reference used to create the container (e.g. docker://mariadb:11.0.2). If provided, it will be written into the Proxmox notes (description) as an identifiable line."
    },
    {
      "id": "oci_image_tag",
      "name": "OCI Image Tag",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Optional: Actual OCI image tag/version that was downloaded (e.g. 0.17.5). If provided, it will be written into the Proxmox notes as Version."
    },
    {
      "id": "disk_size",
      "name": "Disk size",
      "type": "string",
      "default": "4",
      "description": "Disk size for the container in GB",
      "advanced": true
    },
    {
      "id": "rootfs_storage",
      "name": "Rootfs Storage",
      "type": "enum",
      "enumValuesTemplate": "list-available-pve-rootdir-storage.json",
      "description": "Proxmox storage for the container rootfs",
      "advanced": true
    },
    {
      "id": "memory",
      "name": "Memory in MB",
      "type": "number",
      "default": 512,
      "description": "Memory for the container in MB",
      "advanced": true
    },
    {
      "id": "bridge",
      "name": "Network bridge",
      "type": "string",
      "default": "vmbr0",
      "description": "Network bridge to use",
      "advanced": true
    },
    {
      "id": "hostname",
      "name": "Hostname",
      "required": true,
      "type": "string",
      "description": "Hostname for the LXC container"
    },
    {
      "id": "uid",
      "name": "UID",
      "type": "string",
      "default": "0",
      "description": "UID for UID/GID mapping and permissions. If provided, will be mapped directly between host and container (1:1 mapping). Default is 0 (root).",
      "advanced": true
    },
    {
      "id": "gid",
      "name": "GID",
      "type": "string",
      "default": "0",
      "description": "GID for UID/GID mapping and permissions. If provided, will be mapped directly between host and container (1:1 mapping). Default is 0 (root).",
      "advanced": true
    },
    {
      "id": "username",
      "name": "Username",
      "type": "string",
      "default": "root",
      "description": "Optional: Username to create on the VE host before container creation. This ensures consistent UID/GID mapping between host and container. Default is root. If not provided, root will be used.",
      "advanced": true
    },
    {
      "id": "deployer_base_url",
      "name": "Deployer Base URL",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Auto-injected by backend: Base URL of the deployer for log viewer links in Proxmox notes."
    },
    {
      "id": "ve_context_key",
      "name": "VE Context Key",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Auto-injected by backend: VE context identifier for API calls."
    }
  ],
  "commands": [
    {
      "name": "Create LXC container",
      "script": "conf-create-lxc-container.sh",
      "outputs": [
        "vm_id"
      ]
    },
    {
      "name": "Setup UID mapping",
      "script": "conf-setup-lxc-uid-mapping.py",
      "library": "setup_lxc_idmap_common.py"
    },
    {
      "name": "Setup GID mapping",
      "script": "conf-setup-lxc-gid-mapping.py",
      "library": "setup_lxc_idmap_common.py"
    },
    {
      "name": "Compute Static IPs",
      "template": "104-conf-lxc-static-ip-prefix.json"
    },
    {
      "name": "Set Static IP for LXC",
      "template": "105-conf-set-static-ip-for-lxc.json"
    },
    {
      "name": "Update /etc/hosts entries",
      "template": "106-conf-update-etc-hosts-on-ve.json"
    },
    {
      "name": "Map Serial Device",
      "template": "110-conf-map-serial.json"
    },
    {
      "name": "Create Storage Volumes",
      "template": "150-conf-create-storage-volumes-for-lxc.json"
    },
    {
      "name": "Set Env Variables in LXC",
      "template": "170-conf-set-environment-variables-in-lxc.json"
    },
    {
      "name": "Write LXC Notes",
      "template": "190-host-write-lxc-notes.json"
    }
  ]
}