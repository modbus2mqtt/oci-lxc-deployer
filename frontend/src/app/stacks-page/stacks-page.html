<div class="stacks-page">
  <header class="page-header">
    <h1>Environment Stacks</h1>
    <p class="subtitle">Manage reusable environment variable sets</p>
  </header>

  <div class="stacks-controls">
    <mat-form-field appearance="outline" class="stacktype-selector">
      <mat-label>Stack Type</mat-label>
      <mat-select [value]="selectedStacktype()" (selectionChange)="onStacktypeChange($event.value)">
        @for (tt of stacktypes(); track tt.name) {
          <mat-option [value]="tt.name">{{ tt.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <button mat-flat-button color="primary" (click)="startCreate()" [disabled]="isEditing() || stacktypes().length === 0">
      <mat-icon>add</mat-icon>
      Create Stack
    </button>
    @if (showCreateDefaultButton()) {
      <button mat-stroked-button color="accent" (click)="startCreateDefault()" [disabled]="isEditing()" matTooltip="Create a 'default' stack that keeps the original hostname">
        <mat-icon>bookmark_add</mat-icon>
        Create Default Stack
      </button>
    }
  </div>

  @if (loading() && !isEditing()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }

  <!-- Create/Edit Form -->
  @if (isEditing()) {
    <mat-card class="stack-form-card">
      <mat-card-header>
        <mat-card-title>{{ isCreating() ? 'Create New Stack' : 'Edit Stack' }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="stackForm" (ngSubmit)="saveStack()">
          <div class="form-row">
            <mat-form-field appearance="outline" class="name-field">
              <mat-label>Stack Name</mat-label>
              <input matInput formControlName="name" required placeholder="e.g., production, staging" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="stacktype-field">
              <mat-label>Stack Type</mat-label>
              <mat-select formControlName="stacktype" required>
                @for (tt of stacktypes(); track tt.name) {
                  <mat-option [value]="tt.name">{{ tt.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <h4>Environment Variables</h4>
          <app-key-value-table
            [items]="stackEntries"
            keyPlaceholder="Variable Name"
            valuePlaceholder="Value"
            keyLabel="variable"
            (itemsChange)="onEntriesChange($event)"
          />

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="cancelEdit()">Cancel</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="stackForm.invalid || loading()">
              @if (loading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                {{ isCreating() ? 'Create' : 'Save' }}
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }

  <!-- Stacks List -->
  @if (!loading() || isEditing()) {
    <div class="stacks-list">
      @if (stacks().length === 0 && !isEditing()) {
        <div class="no-stacks">
          @if (stacktypes().length === 0) {
            <mat-icon>info</mat-icon>
            <p>No stack types defined. Add stack types in <code>json/stacktypes.json</code>.</p>
          } @else {
            <mat-icon>folder_open</mat-icon>
            <p>No stacks found for type "{{ selectedStacktype() }}". Create your first stack.</p>
          }
        </div>
      }

      <mat-accordion>
        @for (stack of stacks(); track stack.id) {
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ stack.name }}
                @if (isDefaultStack(stack)) {
                  <span class="default-badge" matTooltip="Keeps original hostname during deployment">default</span>
                }
              </mat-panel-title>
              <mat-panel-description>
                {{ stack.entries.length }} variable{{ stack.entries.length !== 1 ? 's' : '' }}
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="stack-entries">
              @if (stack.entries.length === 0) {
                <p class="no-entries">No variables defined</p>
              } @else {
                @for (entry of stack.entries; track entry.name) {
                  <div class="entry-row">
                    <span class="entry-name">{{ entry.name }}</span>
                    <span class="entry-value">{{ entry.value }}</span>
                  </div>
                }
              }
            </div>

            <mat-action-row>
              <button mat-button (click)="startEdit(stack)" [disabled]="isEditing()">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
              <button mat-button color="warn" (click)="deleteStack(stack, $event)" [disabled]="isEditing()">
                <mat-icon>delete</mat-icon>
                Delete
              </button>
            </mat-action-row>
          </mat-expansion-panel>
        }
      </mat-accordion>
    </div>
  }
</div>
