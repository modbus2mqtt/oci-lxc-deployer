
<div class="dialog-header">
	@if (data.app.iconContent) {
		<img class="app-icon" [src]="'data:' + (data.app.iconType || 'image/png') + ';base64,' + data.app.iconContent" alt="App Icon" />
	}
	<div class="header-text">
		<h2>Configuration for {{ data.app.name }}</h2>
		<p>{{ data.app.description }}</p>
	</div>
</div>

@if (taskKey === 'addon-reconfigure' && existingMountPoints.length > 0) {
	<div class="existing-mounts-info">
		<h4>Existing Volumes</h4>
		<ul>
			@for (mp of existingMountPoints; track mp.target) {
				<li><code>{{ mp.target }}</code></li>
			}
		</ul>
	</div>
}

<form [formGroup]="form" (ngSubmit)="save()">
	@if (!loading()) {
		@if (showMissingRequiredHint) {
			<div class="missing-required-hint" role="alert">
				<strong>Missing required parameters detected.</strong>
				<div class="missing-required-text">
					If these values should be auto-filled, verify that the parameters template is included
					and runs before the dependent template, and that no local override hides it.
				</div>
				<div class="missing-required-list">
					Missing: {{ missingRequiredParamsLabel }}
				</div>
				<div class="missing-required-task">Task key: {{ taskKey }}</div>
			</div>
		}
		<div class="group-container">
			@if (availableAddons.length > 0) {
				<div class="addons-section">
					<h3>Optional Addons</h3>
					<p class="addons-description">Select additional features to install with this application</p>
					<div class="addons-list">
						@for (addon of availableAddons; track addon.id) {
							<div class="addon-entry">
								<div class="addon-header">
									<mat-checkbox
										[checked]="isAddonSelected(addon.id)"
										(change)="toggleAddon(addon.id, $event.checked)">
										<div class="addon-item">
											<span class="addon-name">{{ addon.name }}</span>
											@if (addon.description) {
												<span class="addon-description">{{ addon.description }}</span>
											}
										</div>
									</mat-checkbox>
									@if (isAddonSelected(addon.id) && hasAddonParameters(addon)) {
										<button type="button" class="addon-configure-btn" (click)="toggleAddonExpanded(addon.id, $event)">
											<span class="configure-icon">{{ isAddonExpanded(addon.id) ? '▼' : '▶' }}</span>
											<span class="configure-text">Configure</span>
										</button>
									}
								</div>
								@if (isAddonSelected(addon.id) && isAddonExpanded(addon.id) && addon.parameters) {
									<div class="addon-parameters-inline">
										@for (param of addon.parameters; track param.id) {
											@if (!param.advanced || showAdvanced()) {
												<app-parameter-group
													[groupName]="addon.name"
													[groupedParameters]="getAddonGroupedParameters(addon.name, param)"
													[form]="form"
													[showAdvanced]="showAdvanced()"
												/>
											}
										}
									</div>
								}
							</div>
						}
					</div>
				</div>
			}
			@if (addonsLoading()) {
				<div class="addons-loading">Loading addons...</div>
			}
			@for (groupName of groupNames; track groupName) {
				<app-parameter-group
					[groupName]="groupName"
					[groupedParameters]="groupedParameters"
					[form]="form"
					[showAdvanced]="showAdvanced()"
				/>
			}
		</div>
		<div class="trace-action">
			<button mat-stroked-button type="button" (click)="openTemplateTrace()">Template trace</button>
		</div>
			@if (hasAdvancedParams()) {
				<div class="advanced-toggle" (click)="toggleAdvanced()" (keyup.enter)="toggleAdvanced()" (keyup.space)="toggleAdvanced()" tabindex="0" role="button" [attr.aria-expanded]="showAdvanced()">
					<span class="toggle-icon">{{ showAdvanced() ? '▼' : '▶' }}</span>
					<span class="toggle-text">{{ showAdvanced() ? 'Hide' : 'Show' }} Advanced Options</span>
				</div>
			}
			<ng-content select="[slot=actions]"></ng-content>
			@if (!customActions) {
				@if (hasError()) {
					<div class="dialog-actions">
						<button mat-stroked-button color="primary" type="button" (click)="close()">Close</button>
					</div>
				} @else {
					<div class="dialog-actions">
						<button mat-stroked-button color="primary" type="button" (click)="close()">Cancel</button>
						<button mat-flat-button color="accent" type="submit" [disabled]="form.invalid || loading()">Install</button>
					</div>
				}
			}
		}
	@if (loading()) {
		<div>Loading parameters ...</div>
	}
</form>
