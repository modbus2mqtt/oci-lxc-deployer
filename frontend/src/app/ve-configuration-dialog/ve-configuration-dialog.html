
<div class="dialog-header">
	@if (data.app.iconContent) {
		<img class="app-icon" [src]="'data:' + (data.app.iconType || 'image/png') + ';base64,' + data.app.iconContent" alt="App Icon" />
	}
	<div class="header-text">
		<h2>Configuration for {{ data.app.name }}</h2>
		<p>{{ data.app.description }}</p>
	</div>
</div>

@if (taskKey === 'addon-reconfigure' && existingMountPoints.length > 0) {
	<div class="existing-mounts-info">
		<h4>Existing Volumes</h4>
		<ul>
			@for (mp of existingMountPoints; track mp.target) {
				<li><code>{{ mp.target }}</code></li>
			}
		</ul>
	</div>
}

<form [formGroup]="form" (ngSubmit)="save()">
	@if (!loading()) {
		@if (showMissingRequiredHint) {
			<div class="missing-required-hint" role="alert">
				<strong>Missing required parameters detected.</strong>
				<div class="missing-required-text">
					If these values should be auto-filled, verify that the parameters template is included
					and runs before the dependent template, and that no local override hides it.
				</div>
				<div class="missing-required-list">
					Missing: {{ missingRequiredParamsLabel }}
				</div>
				<div class="missing-required-task">Task key: {{ taskKey }}</div>
			</div>
		}
		<div class="group-container">
			<app-addon-section
				[availableAddons]="availableAddons"
				[selectedAddons]="selectedAddons()"
				[expandedAddons]="expandedAddons()"
				[form]="form"
				[showAdvanced]="showAdvanced()"
				[availableStacks]="availableStacks()"
				[isLoading]="addonsLoading()"
				(addonToggled)="toggleAddon($event.addonId, $event.checked)"
				(addonExpandedChanged)="toggleAddonExpandedById($event)"
				(stackSelected)="onStackSelected($event)"
				(createStackRequested)="onCreateStackRequested()"
			></app-addon-section>
			@if (data.app.stacktype && filteredStacks().length > 0) {
				<div class="secrets-selector">
					<app-stack-selector
						[availableStacks]="filteredStacks()"
						[selectedStack]="selectedStack"
						[label]="'Secrets'"
						[showCreateButton]="false"
						[showManageLink]="true"
						[showEntryCount]="false"
						[showDefaultHint]="true"
						(stackSelected)="onStackSelected($event)"
					></app-stack-selector>
				</div>
			}
			@for (groupName of groupNames; track groupName) {
				<app-parameter-group
					[groupName]="groupName"
					[groupedParameters]="groupedParameters"
					[form]="form"
					[showAdvanced]="showAdvanced()"
					[availableStacks]="availableStacks()"
					(stackSelected)="onStackSelected($event)"
					(createStackRequested)="onCreateStackRequested()"
				/>
			}
		</div>
		<div class="trace-action">
			<button mat-stroked-button type="button" (click)="openTemplateTrace()">Template trace</button>
		</div>
			@if (hasAdvancedParams()) {
				<div class="advanced-toggle" (click)="toggleAdvanced()" (keyup.enter)="toggleAdvanced()" (keyup.space)="toggleAdvanced()" tabindex="0" role="button" [attr.aria-expanded]="showAdvanced()">
					<span class="toggle-icon">{{ showAdvanced() ? '▼' : '▶' }}</span>
					<span class="toggle-text">{{ showAdvanced() ? 'Hide' : 'Show' }} Advanced Options</span>
				</div>
			}
			<ng-content select="[slot=actions]"></ng-content>
			@if (!customActions) {
				@if (hasError()) {
					<div class="dialog-actions">
						<button mat-stroked-button color="primary" type="button" (click)="close()">Close</button>
					</div>
				} @else {
					<div class="dialog-actions">
						<button mat-stroked-button color="primary" type="button" (click)="close()">Cancel</button>
						<button mat-flat-button color="accent" type="submit" data-testid="confirm-install-btn" [disabled]="form.invalid || loading()">Install</button>
					</div>
				}
			}
		}
	@if (loading()) {
		<div>Loading parameters ...</div>
	}
</form>
