<h2>Process Monitor</h2>

@if (messages && messages.length > 0) {
  <mat-accordion [multi]="true">
    @for (group of messages; track group.application + group.task) {
      <mat-expansion-panel [expanded]="shouldBeExpanded(group)">
        <mat-expansion-panel-header>
          <mat-panel-title>{{ group.application }} / {{ group.task }}</mat-panel-title>
        </mat-expansion-panel-header>
        <ng-container *ngTemplateOutlet="groupContent; context: { group: group }"></ng-container>
      </mat-expansion-panel>
    }
  </mat-accordion>
} @else {
  <div>No process messages available.</div>
}

<!-- Shared template for group content -->
<ng-template #groupContent let-group="group">
  <!-- Successful commands as compact list -->
  <ul class="success-list">
    @for (msg of group.messages; track msg.index) {
      @if (msg.exitCode === 0) {
        <li>
          <span class="success-icon">✓</span>
          <span class="command-text">{{ msg.command }}</span>
          @if (msg.stderr) {
            <button mat-icon-button type="button" (click)="openStderrDialog(msg)" class="info-button" [attr.aria-label]="'Show stderr output for ' + msg.command">
              <mat-icon>info</mat-icon>
            </button>
          }
        </li>
      }
    }
  </ul>

  <!-- Success message when all completed -->
  @for (msg of group.messages; track msg.index) {
    @if (msg.finished) {
      <div class="success-block" data-testid="installation-success">
        <span class="success-icon-large">✓</span>
        <strong>{{ msg.result }}</strong>
        <button class="back-btn" type="button" (click)="close()">Schließen</button>
      </div>
    }
  }

  <!-- Error displayed prominently with restart button -->
  @for (msg of group.messages; track msg.index) {
    @if (msg.exitCode !== 0 && !msg.finished) {
      <div class="error-block" data-testid="installation-error">
        <div class="error-header">
          <span class="error-icon">✗</span>
          <strong>{{ msg.command }}</strong>
          <span class="exit-code">Exit code: {{ msg.exitCode }}</span>
        </div>
        @if (msg.error?.message) {
          <div class="error-message">{{ msg.error.message }}</div>
        }
        @if (msg.stderr) {
          <pre class="error-stderr">{{ msg.stderr }}</pre>
        }
        @if (group.restartKey) {
          <div class="restart-buttons">
            <button class="restart-btn" (click)="triggerRestart(group)" title="Restart from last successful step">
              ↻ Restart
            </button>
            <button class="restart-full-btn" (click)="triggerRestartFull(group)" title="Restart installation from beginning with same parameters">
              ↻↻ Restart from Beginning
            </button>
          </div>
        }
      </div>
    }
  }
</ng-template>
