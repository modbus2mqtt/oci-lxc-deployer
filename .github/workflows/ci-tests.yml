name: CI Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Check if relevant code changed (skip CI for docs-only etc.)
  # ============================================================

  check-changes:
    name: Check for code changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'backend/**'
              - 'frontend/**'
              - 'e2e/**'
              - 'json/**'
              - 'scripts/**'
              - 'install-oci-lxc-deployer.sh'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.nvmrc'
              - '.github/workflows/ci-tests.yml'

  # ============================================================
  # Wake PVE host and ensure test-worker is reachable
  # All infrastructure details live in the runner's environment,
  # not in this workflow. See: pvetest --help
  # ============================================================

  wake-backend:
    needs: [check-changes]
    if: needs.check-changes.outputs.code == 'true'
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 10
    steps:
      - name: Wake backend and wait for test-worker
        run: pvetest wake

  # ============================================================
  # All tests run via pvetest on a remote test-worker.
  # The runner on pve1 is just a relay.
  # ============================================================

  unit-tests:
    needs: [wake-backend]
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 20
    steps:
      - name: Checkout on test-worker
        run: pvetest checkout ${{ github.sha }} https://github.com/${{ github.repository }}.git

      - name: Install dependencies
        run: pvetest exec pnpm install --frozen-lockfile

      - name: Code quality (jscpd)
        run: pvetest exec npx jscpd --config .jscpd.json backend/src frontend/src

      - name: Frontend tests
        run: pvetest exec "cd frontend && CI=true pnpm test"

      - name: Backend tests
        run: pvetest exec "cd backend && CI=true pnpm test:all"

      - name: Fetch coverage
        if: always()
        run: pvetest fetch backend/coverage/ /tmp/coverage/ || true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: /tmp/coverage/
          retention-days: 7

  template-tests:
    needs: [wake-backend]
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 30
    steps:
      - name: Checkout on test-worker
        run: pvetest checkout ${{ github.sha }} https://github.com/${{ github.repository }}.git

      - name: Install dependencies
        run: pvetest exec "cd backend && pnpm install --frozen-lockfile"

      - name: Template tests
        run: pvetest exec "cd backend && CI=true E2E_INSTANCE=github-action pnpm test:templates"

  install-test:
    needs: [wake-backend]
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 30
    steps:
      - name: Install test (snapshot rollback + install + verify)
        run: pvetest install-test ${{ github.sha }} https://github.com/${{ github.repository }}.git

  e2e-tests:
    needs: [wake-backend]
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 45
    steps:
      - name: Checkout on test-worker
        run: pvetest checkout ${{ github.sha }} https://github.com/${{ github.repository }}.git

      - name: Install and build
        run: |
          pvetest exec pnpm install --frozen-lockfile
          pvetest exec npx playwright install chromium
          pvetest exec pnpm run build

      - name: Clean test containers
        run: pvetest exec "./e2e/clean-test-containers.sh github-action" || true

      - name: Playwright E2E tests
        run: pvetest exec "CI=true E2E_INSTANCE=github-action npx playwright test --project=nested-vm"

      - name: Fetch Playwright report
        if: always()
        run: pvetest fetch e2e/test-results/ /tmp/playwright-report/ || true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: /tmp/playwright-report/
          retention-days: 7
