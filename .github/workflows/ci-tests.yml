name: CI Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Check if relevant code changed (skip CI for docs-only etc.)
  # ============================================================

  check-changes:
    name: Check for code changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'backend/**'
              - 'frontend/**'
              - 'e2e/**'
              - 'scripts/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.nvmrc'
              - '.github/workflows/ci-tests.yml'

  # ============================================================
  # Fast tests on GitHub-hosted runners (parallel, no Proxmox)
  # ============================================================

  code-quality:
    needs: [check-changes]
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Run jscpd duplicate check
        run: npx jscpd --config .jscpd.json backend/src frontend/src

  frontend-vitest:
    needs: [check-changes]
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Run frontend tests
        working-directory: ./frontend
        run: pnpm test
        env:
          CI: true

  backend-vitest:
    needs: [check-changes]
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Install dependencies
        working-directory: ./backend
        run: pnpm install --frozen-lockfile

      - name: Run backend unit + integration tests
        working-directory: ./backend
        run: pnpm test:all
        env:
          CI: true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/
          retention-days: 7

  # ============================================================
  # Slow tests on self-hosted runner (sequential, needs Proxmox)
  # ============================================================

  wake-backend:
    needs: [check-changes]
    if: needs.check-changes.outputs.code == 'true'
    runs-on: [self-hosted, linux, pve1]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5

      - name: Ensure backend is available
        run: ./e2e/scripts/ensure-backend.sh
        env:
          E2E_INSTANCE: github-action

  template-tests:
    runs-on: [self-hosted, linux, pve1]
    needs: [wake-backend]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        working-directory: ./backend
        run: pnpm install --frozen-lockfile

      - name: Run template tests
        working-directory: ./backend
        run: pnpm test:templates
        env:
          CI: true
          E2E_INSTANCE: github-action

  e2e-tests:
    runs-on: [self-hosted, linux, pve1]
    needs: [wake-backend]
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium
        run: npx playwright install chromium

      - name: Build project
        run: pnpm run build

      - name: Clean test containers
        run: ./e2e/clean-test-containers.sh github-action || true

      - name: Run Playwright E2E tests
        run: npx playwright test --project=nested-vm
        env:
          CI: true
          E2E_INSTANCE: github-action

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/test-results/
          retention-days: 7
